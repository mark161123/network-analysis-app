<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Analysis Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        .table tbody tr:hover { background-color: #f9fafb; }
        /* Styling for the AI report */
        .ai-report-content p { margin-bottom: 1rem; }
        .ai-report-content b, .ai-report-content strong { color: #111827; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl font-bold text-indigo-600">Net-Dash</span>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="{{ url_for('home') }}" class="bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Dashboard</a>
                        <a href="{{ url_for('about') }}" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">About</a>
                        <a href="{{ url_for('logout') }}" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Network Traffic Analysis</h1>
            <p class="mt-2 text-lg text-gray-600">Upload a CSV file to train the model and visualize insights.</p>
        </header>

        <!-- Upload Form Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
            <form id="uploadForm">
                <div class="mb-4">
                    <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File:</label>
                    <input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" id="fileInput" accept=".csv" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    Upload & Process
                </button>
            </form>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center my-10" style="display: none;">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-indigo-600 motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div>
            <p class="mt-4 text-gray-600">Processing your file, please wait...</p>
        </div>
        
        <!-- Error Message Box -->
        <div id="errorBox" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" style="display: none;" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="errorMessage"></span>
        </div>

        <!-- Results Section -->
        <div id="result" class="bg-white rounded-2xl shadow-lg p-6 md:p-8" style="display: none;">
            <!-- Accuracy and AI Button Container -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="p-4 bg-green-100 text-green-800 rounded-lg flex-grow">
                    <h2 class="text-lg font-semibold">Model Accuracy</h2>
                    <p id="accuracy" class="text-3xl font-bold"></p>
                </div>
                <button id="generateReportBtn" class="w-full md:w-auto bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all transform hover:scale-105">
                    ✨ Generate AI Report
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav id="tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button onclick="changeTab(event, 'preview')" class="tab tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Data Preview</button>
                    <button onclick="changeTab(event, 'sums')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Feature Sums</button>
                    <button onclick="changeTab(event, 'heatmap')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Correlation Heatmap</button>
                    <button onclick="changeTab(event, 'importance')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Feature Importance</button>
                    <!-- AI Summary Tab (initially hidden) -->
                    <button id="aiTab" onclick="changeTab(event, 'aiSummary')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" style="display: none;">AI Summary</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="py-6">
                <div id="preview" class="tab-content tab-content-active"><h3 class="text-xl font-semibold text-gray-800 mb-4">First 5 Rows of Data</h3><div id="dataPreview" class="overflow-x-auto"></div></div>
                <div id="sums" class="tab-content"><h3 class="text-xl font-semibold text-gray-800 mb-4">Sum of Features</h3><img id="barPlot" alt="Feature Sums Bar Plot" class="mx-auto rounded-lg shadow-md"></div>
                <div id="heatmap" class="tab-content"><h3 class="text-xl font-semibold text-gray-800 mb-4">Feature Correlation Heatmap</h3><img id="heatmapPlot" alt="Correlation Heatmap" class="mx-auto rounded-lg shadow-md"></div>
                <div id="importance" class="tab-content"><h3 class="text-xl font-semibold text-gray-800 mb-4">Feature Importance from Model</h3><img id="importancePlot" alt="Feature Importance Plot" class="mx-auto rounded-lg shadow-md"></div>
                <!-- AI Summary Content Area -->
                <div id="aiSummary" class="tab-content"><h3 class="text-xl font-semibold text-gray-800 mb-4">✨ AI Generated Report</h3><div id="aiReportContent" class="ai-report-content prose max-w-none"></div></div>
            </div>
        </div>
    </div>

    <script>
        // Store analysis data globally to be accessible by the report generator
        let analysisData = {};

        // DOM Element References
        const uploadForm = document.getElementById('uploadForm');
        const loadingDiv = document.getElementById('loading');
        const resultDiv = document.getElementById('result');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const aiTab = document.getElementById('aiTab');
        const aiReportContent = document.getElementById('aiReportContent');
        
        // Form Submission Handler
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                errorMessage.textContent = 'Please select a file to upload.';
                errorBox.style.display = 'block';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            errorBox.style.display = 'none';
            aiTab.style.display = 'none'; // Hide AI tab on new upload

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    // Store data for AI report
                    analysisData.accuracy = data.accuracy;
                    analysisData.importances = data.importances;

                    // Populate results
                    document.getElementById('accuracy').textContent = data.accuracy;
                    document.getElementById('barPlot').src = `data:image/png;base64,${data.bar_plot}`;
                    document.getElementById('heatmapPlot').src = `data:image/png;base64,${data.heatmap}`;
                    document.getElementById('importancePlot').src = `data:image/png;base64,${data.importance_plot}`;
                    document.getElementById('dataPreview').innerHTML = data.data_preview;

                    resultDiv.style.display = 'block';
                } else {
                    errorMessage.textContent = data.error || 'An error occurred.';
                    errorBox.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = 'An unexpected network error occurred.';
                errorBox.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
            }
        });

        // AI Report Button Handler
        generateReportBtn.addEventListener('click', async () => {
            generateReportBtn.disabled = true;
            generateReportBtn.textContent = '✨ Generating...';
            aiReportContent.innerHTML = `<div class="text-center"><div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-purple-600 motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div><p class="mt-2">The AI is analyzing the results...</p></div>`;
            aiTab.style.display = 'inline-block'; // Show the tab
            
            // Switch to the AI tab
            changeTab({ currentTarget: aiTab }, 'aiSummary');

            try {
                const response = await fetch('/generate_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisData)
                });
                const data = await response.json();
                if (response.ok) {
                    aiReportContent.innerHTML = data.report;
                } else {
                    aiReportContent.innerHTML = `<p class="text-red-500">Error: ${data.error || 'Could not generate report.'}</p>`;
                }
            } catch (error) {
                aiReportContent.innerHTML = `<p class="text-red-500">An unexpected network error occurred while generating the report.</p>`;
            } finally {
                generateReportBtn.disabled = false;
                generateReportBtn.textContent = '✨ Regenerate AI Report';
            }
        });

        // Tab Switching Logic
        function changeTab(event, tabID) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('tab-content-active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.getElementById(tabID).classList.add('tab-content-active');
            event.currentTarget.classList.add('tab-active');
        }
    </script>
</body>
</html>
